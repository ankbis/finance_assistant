{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Stock Holdings</h1>
</div>

<div class="grid-layout">
    <!-- Add New Holding Form -->
    <div class="card">
        <h2 class="card-title">Add New Stock</h2>
        <p class="card-subtitle">Enter the details of your stock purchase</p>
        <form id="addHoldingForm" class="form" onsubmit="return addHolding(event)">
            <div class="input-row two">
                <div>
                    <label class="label" for="symbol">Stock Symbol</label>
                    <input type="text" class="input" id="symbol" name="symbol" placeholder="e.g. RELIANCE" required>
                </div>
                <div>
                    <label class="label" for="quantity">Quantity</label>
                    <input type="number" class="input" id="quantity" name="quantity" placeholder="Number of shares" required>
                </div>
            </div>
            <div>
                <label class="label" for="avg_price">Average Price</label>
                <input type="number" step="0.01" class="input" id="avg_price" name="avg_price" placeholder="Price per share" required>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">Add Holding</button>
            </div>
        </form>
    </div>

    <!-- Current Holdings Table -->
    <div class="card">
        <h2 class="card-title">Current Holdings</h2>
        <div class="holdings-table">
            {% if holdings %}
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Current</th>
                        <th>Investment</th>
                        <th>Value</th>
                        <th>P&L</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holding in holdings %}
                    <tr>
                        <td><strong>{{ holding.symbol }}</strong></td>
                        <td>{{ holding.quantity }}</td>
                        <td>₹{{ "%.2f"|format(holding.avg_price) }}</td>
                        <td>₹{{ "%.2f"|format(holding.current_price) }}</td>
                        <td>₹{{ "%.2f"|format(holding.total_investment) }}</td>
                        <td>₹{{ "%.2f"|format(holding.current_value) }}</td>
                        <td class="{{ 'profit' if holding.profit_loss > 0 else 'loss' }}">
                            ₹{{ "%.2f"|format(holding.profit_loss) }}
                            <small>({{ "%.1f"|format(holding.profit_loss_percentage) }}%)</small>
                        </td>
                        <td class="actions">
                            <button class="btn btn-ghost btn-sm" onclick="editHolding('{{ holding.id }}')">Edit</button>
                            <button class="btn btn-ghost btn-sm danger" onclick="deleteHolding('{{ holding.id }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <p>You don't have any stock holdings yet.</p>
                <p class="muted">Add your first stock holding using the form above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function editHolding(id) {
    // TODO: Implement edit functionality
}

async function addHolding(event) {
    event.preventDefault();
    const form = event.target;
    const formData = {
        symbol: form.symbol.value.toUpperCase(),
        quantity: parseInt(form.quantity.value),
        avg_price: parseFloat(form.avg_price.value),
        current_price: parseFloat(form.avg_price.value) // Initially set to avg_price, will be updated later
    };

    try {
        const response = await fetch('/holdings/stocks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error adding holding: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding holding: ' + error.message);
    }
    return false;
}

function deleteHolding(id) {
    if (confirm('Are you sure you want to delete this holding?')) {
        fetch(`/holdings/stocks/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
}
</script>
{% endblock %}